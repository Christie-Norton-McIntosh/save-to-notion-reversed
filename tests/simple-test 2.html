<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Test - Image Replacement</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }
      h1 {
        color: #333;
        margin: 0 0 10px 0;
      }
      .subtitle {
        color: #666;
        margin: 0 0 30px 0;
        font-size: 14px;
      }
      .instruction {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #667eea;
      }
      .instruction h3 {
        margin-top: 0;
        color: #667eea;
      }
      .instruction ol {
        margin: 10px 0;
        padding-left: 20px;
      }
      .instruction li {
        margin: 8px 0;
        line-height: 1.6;
      }
      code {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 13px;
      }
      .code-block {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 6px;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
        margin: 15px 0;
      }
      .note {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }
      .note-title {
        font-weight: bold;
        color: #856404;
        margin-bottom: 5px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
      }
      .button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 10px 5px 10px 0;
      }
      .button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      .input-group {
        margin: 15px 0;
      }
      .input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }
      .input-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }
      #output {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        min-height: 50px;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-wrap: break-word;
        display: none;
      }
      #output.show {
        display: block;
      }
      .emoji {
        font-size: 20px;
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1><span class="emoji">üß™</span>Image Replacement Test</h1>
      <p class="subtitle">
        Simple console-based test for debugging image replacement
      </p>

      <div class="note">
        <div class="note-title">
          ‚ö†Ô∏è Important: This page must be opened in a specific way
        </div>
        <p style="margin: 5px 0 0 0">
          The test script needs access to the Chrome extension API, which is
          only available when loaded as part of the extension.
        </p>
      </div>

      <div class="instruction">
        <h3>üìù How to Run the Test</h3>
        <ol>
          <li>
            Open Chrome DevTools (<code>F12</code> or <code>Cmd+Option+I</code>)
          </li>
          <li>Go to the <strong>Console</strong> tab</li>
          <li>
            Copy and paste the script from <code>test-in-console.js</code>
          </li>
          <li>Enter your Page ID and Space ID below</li>
          <li>Click "Copy Test Command" and paste it in the console</li>
          <li>Press Enter to run the test</li>
        </ol>
      </div>

      <div class="instruction">
        <h3>üîë Get Your IDs</h3>
        <p><strong>Page ID:</strong></p>
        <ul>
          <li>Open a Notion page</li>
          <li>
            Copy the URL: <code>https://notion.so/.../abc123def456...</code>
          </li>
          <li>Extract the 32-character hex string (remove dashes)</li>
        </ul>
        <p><strong>Space ID:</strong></p>
        <ul>
          <li>Open the Web-2-Notion popup</li>
          <li>Go to Settings</li>
          <li>Copy your workspace/space ID</li>
        </ul>
      </div>

      <div class="input-group">
        <label for="pageIdInput">Page ID:</label>
        <input
          type="text"
          id="pageIdInput"
          placeholder="f6c30c3ad4584ee4a93609be47d7481e"
        />
      </div>

      <div class="input-group">
        <label for="spaceIdInput">Space ID:</label>
        <input
          type="text"
          id="spaceIdInput"
          placeholder="1934a47f-12df-4293-bdae-bbc3308daada"
        />
      </div>

      <button class="button" onclick="copyTestCommand()">
        üìã Copy Test Command
      </button>
      <button class="button" onclick="openConsoleGuide()">
        üìñ Show Console Instructions
      </button>

      <div id="output"></div>

      <div class="instruction">
        <h3>üîç What the Test Does</h3>
        <ol>
          <li>Creates 3 test placeholder entries with data: URLs</li>
          <li>
            Sends a message to the service worker with the placeholder map
          </li>
          <li>
            The service worker should:
            <ul>
              <li>
                Receive the message and log "replaceDataUrlPlaceholders CALLED"
              </li>
              <li>Fetch the page blocks from Notion</li>
              <li>Search for blocks matching the placeholder IDs</li>
              <li>Upload the images</li>
              <li>Replace text blocks with image blocks</li>
            </ul>
          </li>
          <li>Returns success/failure response</li>
        </ol>
      </div>

      <div class="instruction success">
        <h3>‚úÖ Expected Output</h3>
        <p>In the browser console, you should see:</p>
        <div class="code-block">
          üß™ IMAGE REPLACEMENT TEST STARTING üìù Step 1: Creating test
          placeholder map... ‚úì Created 3 placeholders üîå Step 2: Checking Chrome
          extension API... ‚úì Chrome extension API is available üì® Step 3:
          Sending message to service worker... üì¨ Response received! ‚úÖ TEST
          PASSED! ‚úì Replaced 3 placeholder blocks
        </div>

        <p style="margin-top: 15px">
          In the service worker console (chrome://extensions ‚Üí inspect service
          worker):
        </p>
        <div class="code-block">
          [ServiceWorker] replaceDataUrlPlaceholders CALLED [ServiceWorker] ‚úì
          Notion client obtained [ServiceWorker] ‚úì Page blocks loaded: X blocks
          [ServiceWorker] ‚úì‚úì‚úì FOUND MATCH! [ServiceWorker] ‚úì‚úì‚úì ALL DONE!
          Replaced 3 images
        </div>
      </div>

      <div class="note">
        <div class="note-title">üí° Troubleshooting</div>
        <ul style="margin: 10px 0 0 0; padding-left: 20px">
          <li>
            <strong>No service worker logs?</strong> Check that the extension is
            loaded and the service worker is running
          </li>
          <li>
            <strong>API not available?</strong> Make sure you're running the
            test from a page where the extension is active
          </li>
          <li>
            <strong>Blocks not found?</strong> The page needs to have the
            __IMG*__ child blocks first - save a page with images before testing
          </li>
        </ul>
      </div>
    </div>

    <script>
      function copyTestCommand() {
        const pageId = document.getElementById("pageIdInput").value.trim();
        const spaceId = document.getElementById("spaceIdInput").value.trim();

        if (!pageId || !spaceId) {
          alert("Please enter both Page ID and Space ID");
          return;
        }

        const command = `testImageReplacement("${pageId}", "${spaceId}")`;

        navigator.clipboard
          .writeText(command)
          .then(() => {
            const output = document.getElementById("output");
            output.className = "show";
            output.textContent =
              "‚úÖ Copied to clipboard!\n\nCommand:\n" +
              command +
              "\n\nNow:\n1. Open DevTools Console (F12)\n2. Paste and press Enter\n3. Watch the test run!";

            setTimeout(() => {
              output.className = "";
            }, 5000);
          })
          .catch((err) => {
            alert("Failed to copy. Please copy manually:\n\n" + command);
          });
      }

      function openConsoleGuide() {
        const output = document.getElementById("output");
        output.className = "show";
        output.textContent = `üìñ Console Test Instructions:

1. Open this file in a text editor:
   test-in-console.js

2. Copy ALL the code from that file

3. Open Chrome DevTools:
   - Press F12 (Windows/Linux)
   - Press Cmd+Option+I (Mac)

4. Go to the Console tab

5. Paste the code and press Enter
   (You'll see "IMAGE REPLACEMENT TEST LOADED")

6. Enter your Page ID and Space ID in the form above

7. Click "Copy Test Command"

8. Paste in console and press Enter

9. Watch the test run with detailed logs!

Check both consoles:
- Browser console: Shows test progress
- Service worker console: Shows processing details
  (Get to it: chrome://extensions ‚Üí inspect service worker)`;
      }

      // Auto-populate from localStorage if available
      window.addEventListener("load", () => {
        const savedPageId = localStorage.getItem("testPageId");
        const savedSpaceId = localStorage.getItem("testSpaceId");

        if (savedPageId)
          document.getElementById("pageIdInput").value = savedPageId;
        if (savedSpaceId)
          document.getElementById("spaceIdInput").value = savedSpaceId;

        // Save on change
        document
          .getElementById("pageIdInput")
          .addEventListener("change", (e) => {
            localStorage.setItem("testPageId", e.target.value);
          });
        document
          .getElementById("spaceIdInput")
          .addEventListener("change", (e) => {
            localStorage.setItem("testSpaceId", e.target.value);
          });
      });
    </script>
  </body>
</html>
