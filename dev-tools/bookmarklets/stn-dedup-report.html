<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STN — Dedup Report Bookmarklet</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; margin: 24px; color: #0b1220; }
    .container { max-width: 780px; margin: 0 auto; }
    a.bookmark { display: inline-block; padding: 10px 14px; background: linear-gradient(180deg,#1f7aec,#0366d6); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 6px 18px rgba(6,30,60,.12); }
    pre { background:#0f1724;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;font-size:13px; }
    button { margin-left:8px; padding:8px 12px; border-radius:6px; border:0; background:#111827;color:#fff; cursor:pointer }
    .note { color:#475569; margin-top:12px }
    .hint { background:#f1f5f9;border-left:4px solid #94a3b8;padding:12px;border-radius:6px;margin-top:12px }
  </style>
</head>
<body>
  <div class="container">
    <h1>STN — Dedup report bookmarklet</h1>
    <p>Drag the button below to your bookmarks bar, or click <strong>Copy</strong> and paste it into a new bookmark's URL field.</p>

    <p>
      <a class="bookmark" id="stnBookmark" href="javascript:(async()=>{try{function n(s){return(s||'').split('?')[0].split('#')[0]}function g(e){if(!e||!e.tagName)return null;var t=e.tagName.toUpperCase();if(t==='IMG')return'img:'+n(e.getAttribute('src')||e.src||'')+':'+(e.getAttribute('alt')||'').trim()+':'+(e.width||0)+'x'+(e.height||0);if(t==='TABLE')return'table:'+e.querySelectorAll('td,th').length+':'+(e.textContent||'').replace(/\s+/g,' ').trim().slice(0,200);return t.toLowerCase()+':'+(e.textContent||'').replace(/\s+/g,' ').trim().slice(0,120)}const out={id:null,url:location.href,hostname:location.hostname.replace(/^www\./,''),timestamp:new Date().toISOString(),selectors:null,matched:{},duplicates:[]};try{if(typeof getReadableZone==='function'){try{const r=await getReadableZone();out.selectors=r&&r.selector||null}catch(e){}}}catch(e){}const selStr=out.selectors||null,selectors=selStr?selStr.split(',').map(s=>s.trim()).filter(Boolean):[];if(selectors.length){for(const s of selectors){try{const nodes=Array.from(document.querySelectorAll(s)).slice(0,200);out.matched[s]={document:nodes.length,sample:nodes.slice(0,5).map(n=>({tag:n.tagName,cls:n.className,len:(n.textContent||'').trim().length,sig:g(n)}))}}catch(e){out.matched[s]={error:'invalid selector'}}}}else{const imgs=Array.from(document.querySelectorAll('img')).slice(0,500),tables=Array.from(document.querySelectorAll('table')).slice(0,200);out.matched.img={count:imgs.length,sample:imgs.slice(0,5).map(i=>({sig:g(i),src:n(i.getAttribute('src')||i.src||'')}))};out.matched.table={count:tables.length,sample:tables.slice(0,5).map(t=>({sig:g(t),textLen:(t.textContent||'').trim().length}))}}(function quick(root=document,limit=500){const map=new Map(),els=Array.from(root.querySelectorAll('img,table')).slice(0,limit);for(const el of els){const k=g(el)||'(unknown)';if(!map.has(k))map.set(k,[]);map.get(k).push({tag:el.tagName,cls:el.className,len:(el.textContent||'').trim().length,outer:(el.outerHTML||'').replace(/\s+/g,' ').slice(0,200)})}for(const [k,v]of map.entries())if(v.length>1)out.duplicates.push({signature:k,count:v.length,examples:v.slice(0,5)})})();try{const live=(out.selectors?(()=>{try{return document.querySelector(out.selectors.split(',')[0].trim())}catch(e){return null}})():null);if(live)out.sampleFragment=(live.outerHTML||'').replace(/\s+/g,' ').slice(0,1000)}catch(e){}out.id='STN-DEDUP-'+Date.now().toString(36);const header='<<<'+out.id+':BEGIN>>>',footer=header.replace(':BEGIN',':END>>>'),payload=JSON.stringify(out,null,2);try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(header+ '\n'+payload+'\n'+footer);(console.__stn_originalLog||console.log)('STN dedup report copied to clipboard — paste it here') }else{(console.__stn_originalLog||console.log)(header);(console.__stn_originalLog||console.log)(payload);(console.__stn_originalLog||console.log)(footer);(console.__stn_originalLog||console.log)('Clipboard unavailable — copy the JSON block above and paste it into the chat')} }catch(e){(console.__stn_originalLog||console.log)(header);(console.__stn_originalLog||console.log)(payload);(console.__stn_originalLog||console.log)(footer);(console.__stn_originalLog||console.log)('Report printed to console — copy between the markers and paste here')} }catch(err){console.error('STN bookmarklet error:',err);alert('STN bookmarklet failed (see console)');}})();">STN: collect dedup report</a>
      <button id="copyBtn">Copy bookmarklet</button>
    </p>

    <div class="hint">
      Tip: drag the blue button to your bookmarks bar. When you need a report, open the problematic page and click the bookmark.
    </div>

    <h3>Manual install</h3>
    <p>If your browser blocks drag-to-bookmarks, copy the code below and paste it into a new bookmark's URL field.</p>
    <pre id="code" spellcheck="false"></pre>

    <p class="note">After clicking the bookmarklet on the target page, paste the JSON block (between the <<<STN-DEDUP...:BEGIN>>> and :END>>> markers) into the issue or chat.</p>
  </div>

  <script>
    const code = document.getElementById('stnBookmark').href;
    document.getElementById('code').textContent = code;
    document.getElementById('copyBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(code);
        alert('Bookmarklet copied to clipboard — paste into a new bookmark URL field.');
      } catch (e) {
        alert('Clipboard not available. Select and copy the code manually from the box.');
      }
    });
  </script>
</body>
</html>
