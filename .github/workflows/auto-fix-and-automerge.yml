name: Auto-fix and Auto-merge on green

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  checks: read
  pull-requests: write
  actions: write

jobs:
  autofix:
    name: Auto-fix (eslint/prettier) + run tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Add automerge-on-green label for trusted authors
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const ALLOW_LABEL = 'automerge-on-green';
            // auto-label PRs authored by the repo owner to opt-in to automerge
            if (pr && pr.user && pr.user.login === owner) {
              const has = (pr.labels||[]).some(l=>l.name===ALLOW_LABEL);
              if (!has) {
                await github.rest.issues.addLabels({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, labels: [ALLOW_LABEL] });
                core.info('Added automerge-on-green label for trusted author');
              }
            }

      - name: Install deps (fast)
        run: |
          if [ -f package-lock.json ]; then npm ci --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      - name: Run eslint --fix (if configured)
        id: run_eslint
        run: |
          if command -v npx >/dev/null 2>&1 && npx -c "eslint -v" >/dev/null 2>&1; then
            echo "eslint available — running --fix"
            npx eslint --ext .js,.jsx,.ts,.tsx --fix . || true
          else
            echo "eslint not configured or unavailable — skipping";
          fi

      - name: Run prettier --write (if configured)
        run: |
          if [ -f .prettierrc ] || command -v npx >/dev/null 2>&1 && npx -c "prettier -v" >/dev/null 2>&1; then
            npx prettier --write "**/*.{js,ts,jsx,tsx,json,md,css,scss,html}" || true
          else
            echo "prettier not configured — skipping";
          fi

      - name: Run unit tests
        run: |
          if npm test --silent; then echo "tests passed"; else echo "tests failed"; exit 1; fi

      - name: Commit and push fixes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No autofixes to commit"
            exit 0
          fi
          git commit -m "chore: apply automated lint/format fixes"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}

  automerge:
    name: Auto-merge when all required checks are green
    runs-on: ubuntu-latest
    needs: autofix
    if: github.event_name == 'pull_request'
    steps:
      - name: "Check automerge eligibility"
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Auto-merge only for PRs with this label or authored by repo owner
            const ALLOW_LABEL = 'automerge-on-green';
            const isOwner = pr.user && pr.user.login === owner;
            const hasLabel = (pr.labels || []).some(l => l.name === ALLOW_LABEL);
            if (!isOwner && !hasLabel) {
              core.info('Automerge not enabled for this PR (missing label and not authored by repo owner)');
              return {ok:false, reason:'not-enabled'};
            }
            // fetch PR status to ensure mergeable
            const { data: prData } = await github.rest.pulls.get({ owner, repo, pull_number: pr.number });
            if (!prData.mergeable) return {ok:false, reason:'not-mergeable', mergeable_state: prData.mergeable_state};
            // check combined status for head SHA
            const sha = prData.head.sha;
            const { data: combined } = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: sha });
            const statuses = combined.statuses || [];
            const failing = statuses.filter(s => s.state !== 'success' && s.state !== 'neutral');
            if (failing.length) return {ok:false, reason:'checks-failing', failing: failing.map(f=>f.context)};
            return {ok:true, sha};
      - name: Merge PR when eligible
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            await github.rest.pulls.merge({ owner, repo, pull_number: pr.number, merge_method: 'squash' });
            core.info('PR merged by automerge workflow');

  merge-on-green-trigger:
    name: Merge-on-green (runs after external CI)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Find PRs for the head sha and attempt merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head_sha = context.payload.workflow_run.head_sha;
            const prs = await github.rest.search.issuesAndPullRequests({ q: `repo:${owner}/${repo} is:pr is:open ${head_sha}` });
            for (const item of prs.data.items) {
              const prNumber = item.number;
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              const ALLOW_LABEL = 'automerge-on-green';
              const isOwner = pr.user && pr.user.login === owner;
              const hasLabel = (pr.labels || []).some(l => l.name === ALLOW_LABEL);
              if (!isOwner && !hasLabel) continue;
              if (!pr.mergeable) { core.info(`PR#${prNumber} not mergeable: ${pr.mergeable_state}`); continue; }
              await github.rest.pulls.merge({ owner, repo, pull_number: prNumber, merge_method: 'squash' });
              core.info(`Auto-merged PR#${prNumber}`);
            }
