name: CI â€” ensure Playwright jobs removed

# Guard workflow: fail PRs that still introduce Playwright or Playwright-based CI jobs.
# Purpose: prevent CI flakes and accidental re-introduction of archived E2E harness.
on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
  push:
    branches: [main]

jobs:
  detect-playwright:
    runs-on: ubuntu-latest
    name: "Detect Playwright references"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Search repository for Playwright references
        run: |
          set -euo pipefail
          echo "Searching tracked files for 'playwright' (exclude docs and this guard)..."

          # Use git grep so we only scan tracked files (avoids scanning .git, node_modules,
          # and other untracked/vendored content). Exclude documentation and this
          # workflow file itself because both legitimately mention 'playwright'.
          matches=$(git grep -n --full-name -I -e "playwright" || true)

          # Remove allowed occurrences (docs + this guard file) from the results.
          filtered=$(printf '%s\n' "$matches" | grep -vE '(^docs/|\.github/workflows/ci-ensure-no-playwright.yml|docs/PLAYWRIGHT_REMOVAL.md)' || true)

          if [ -n "$filtered" ]; then
            echo "\nERROR: Playwright references found outside allowed exclusions:\n"
            printf '%s\n' "$filtered"
            echo "\nIf Playwright was intentionally removed, delete or disable CI jobs that reference it and remove the dependency from package.json/package-lock.json." >&2
            exit 1
          fi

          echo "No Playwright references found (outside excluded paths)."

  validate-web-2-notion:
    runs-on: ubuntu-latest
    needs: detect-playwright
    name: Verify Web-2-Notion builds/tests (fast sanity)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Web-2-Notion deps (no-audit)
        working-directory: Web-2-Notion
        run: npm ci --no-audit --no-fund

      - name: Run unit tests (fast)
        working-directory: Web-2-Notion
        run: npm test --silent
