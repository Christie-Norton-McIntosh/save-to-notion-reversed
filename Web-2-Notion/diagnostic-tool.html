<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extension Diagnostic</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }
      .check {
        margin: 15px 0;
        padding: 15px;
        border-left: 4px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
      }
      .check.pass {
        border-left-color: #4caf50;
        background: #e8f5e9;
      }
      .check.fail {
        border-left-color: #f44336;
        background: #ffebee;
      }
      .check.warning {
        border-left-color: #ffc107;
        background: #fff8e1;
      }
      .status {
        font-weight: bold;
        margin-right: 10px;
      }
      .pass .status {
        color: #4caf50;
      }
      .fail .status {
        color: #f44336;
      }
      .warning .status {
        color: #ffc107;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin: 10px 5px;
      }
      button:hover {
        opacity: 0.9;
      }
      code {
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      .detail {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”§ Extension Diagnostic Tool</h1>
      <p>
        This tool checks if the image replacement system is properly configured.
      </p>

      <button onclick="runDiagnostic()">Run Diagnostic</button>
      <button onclick="testMessage()">Test Message</button>

      <div id="results"></div>
    </div>

    <script>
      async function runDiagnostic() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p>Running diagnostic...</p>';

        const checks = [];

        // Check 1: Chrome extension API available
        try {
          if (typeof chrome !== 'undefined' && chrome.runtime) {
            checks.push({
              name: 'Chrome Extension API',
              status: 'pass',
              message: 'Chrome extension API is available',
              detail: `Extension ID: ${chrome.runtime.id}`
            });
          } else {
            checks.push({
              name: 'Chrome Extension API',
              status: 'fail',
              message: 'Chrome extension API not available',
              detail: 'Make sure this page is loaded as part of the extension or has proper permissions'
            });
          }
        } catch (e) {
          checks.push({
            name: 'Chrome Extension API',
            status: 'fail',
            message: 'Error checking Chrome API',
            detail: e.message
          });
        }

        // Check 2: Can send messages
        try {
          const testResponse = await chrome.runtime.sendMessage({ type: 'ping' });
          checks.push({
            name: 'Message System',
            status: 'pass',
            message: 'Can send messages to service worker',
            detail: `Response: ${JSON.stringify(testResponse)}`
          });
        } catch (e) {
          checks.push({
            name: 'Message System',
            status: 'warning',
            message: 'Message sent but no response (expected for test ping)',
            detail: e.message
          });
        }

        // Check 3: Test replaceDataUrlPlaceholders message
        try {
          const placeholderMap = {
            '__IMGTEST123__': {
              dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
              alt: 'Test',
              uniqueId: '__IMGTEST123__',
              inlinePlaceholder: '[Test]'
            }
          };

          const response = await chrome.runtime.sendMessage({
            type: 'replaceDataUrlPlaceholders',
            pageId: 'test-page-id',
            spaceId: 'test-space-id',
            placeholderMap: placeholderMap
          });

          if (response && response.error) {
            checks.push({
              name: 'replaceDataUrlPlaceholders Handler',
              status: 'warning',
              message: 'Handler responded but returned error (expected with test IDs)',
              detail: `Error: ${response.error}`
            });
          } else if (response) {
            checks.push({
              name: 'replaceDataUrlPlaceholders Handler',
              status: 'pass',
              message: 'Handler is working!',
              detail: JSON.stringify(response)
            });
          } else {
            checks.push({
              name: 'replaceDataUrlPlaceholders Handler',
              status: 'fail',
              message: 'No response from handler',
              detail: 'The message might not be reaching the service worker'
            });
          }
        } catch (e) {
          checks.push({
            name: 'replaceDataUrlPlaceholders Handler',
            status: 'fail',
            message: 'Error testing handler',
            detail: e.message
          });
        }

        // Check 4: Global placeholder function
        if (typeof window.processDataUrlPlaceholders === 'function') {
          checks.push({
            name: 'processDataUrlPlaceholders Function',
            status: 'pass',
            message: 'Global function is defined',
            detail: 'The function exists and can be called'
          });
        } else {
          checks.push({
            name: 'processDataUrlPlaceholders Function',
            status: 'fail',
            message: 'Global function not found',
            detail: 'This function should be defined in main.js'
          });
        }

        // Check 5: Check for placeholder storage
        if (window.__dataUrlPlaceholders) {
          checks.push({
            name: 'Placeholder Storage',
            status: 'pass',
            message: `Found ${Object.keys(window.__dataUrlPlaceholders).length} stored placeholders`,
            detail: `Keys: ${Object.keys(window.__dataUrlPlaceholders).join(', ')}`
          });
        } else {
          checks.push({
            name: 'Placeholder Storage',
            status: 'warning',
            message: 'No placeholders currently stored',
            detail: 'This is normal if no images have been processed yet'
          });
        }

        // Display results
        let html = '<h2>Diagnostic Results</h2>';
        checks.forEach(check => {
          html += `
            <div class="check ${check.status}">
              <div>
                <span class="status">${check.status === 'pass' ? 'âœ“' : check.status === 'fail' ? 'âœ—' : 'âš '}</span>
                <strong>${check.name}</strong>
              </div>
              <div>${check.message}</div>
              ${check.detail ? `<div class="detail"><code>${check.detail}</code></div>` : ''}
            </div>
          `;
        });

        const passCount = checks.filter(c => c.status === 'pass').length;
        const failCount = checks.filter(c => c.status === 'fail').length;
        const warningCount = checks.filter(c => c.status === 'warning').length;

        html += `
          <div class="check ${failCount > 0 ? 'fail' : 'pass'}" style="margin-top: 20px;">
            <strong>Summary:</strong>
            ${passCount} passed,
            ${warningCount} warnings,
            ${failCount} failed
          </div>
        `;

        resultsDiv.innerHTML = html;

        // Log to console
        console.log('=== DIAGNOSTIC RESULTS ===');
        checks.forEach(check => {
          console.log(`[${check.status.toUpperCase()}] ${check.name}: ${check.message}`);
          if (check.detail) console.log(`  Detail: ${check.detail}`);
        });
      }

      async function testMessage() {
        console.log('Testing message to service worker...');

        const placeholderMap = {
          '__IMGTEST' + Date.now() + '__': {
            dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
            alt: 'Test Image',
            uniqueId: '__IMGTEST' + Date.now() + '__',
            inlinePlaceholder: '[Test Image]'
          }
        };

        console.log('Sending message with payload:', {
          type: 'replaceDataUrlPlaceholders',
          pageId: 'test-page-id-12345',
          spaceId: 'test-space-id-67890',
          placeholderCount: Object.keys(placeholderMap).length
        });

        try {
          const response = await chrome.runtime.sendMessage({
            type: 'replaceDataUrlPlaceholders',
            pageId: 'test-page-id-12345',
            spaceId: 'test-space-id-67890',
            placeholderMap: placeholderMap
          });

          console.log('Response received:', response);
          alert('Message sent! Check the service worker console for logs.\n\n' +
                'Response: ' + JSON.stringify(response, null, 2));
        } catch (e) {
          console.error('Error:', e);
          alert('Error sending message: ' + e.message);
        }
      }

      // Auto-run on load
      window.addEventListener('load', () => {
        console.log('Diagnostic tool loaded');
      });
    </script>
  </body>
</html>
